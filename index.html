<!DOCTYPE html>  
<html lang="en">  
<head>  
    <meta charset="UTF-8">  
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">  
    <title>Pop It LED Game</title>  
    <style>  
        * {  
            margin: 0;  
            padding: 0;  
            box-sizing: border-box;  
            -webkit-tap-highlight-color: transparent;  
        }  
  
        body {  
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;  
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);  
            min-height: 100vh;  
            display: flex;  
            justify-content: center;  
            align-items: center;  
            overflow: hidden;  
            touch-action: manipulation;  
        }  
  
        .rotate-message {  
            display: none;  
            position: fixed;  
            top: 0;  
            left: 0;  
            width: 100%;  
            height: 100%;  
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);  
            z-index: 10000;  
            flex-direction: column;  
            justify-content: center;  
            align-items: center;  
            color: white;  
            text-align: center;  
            padding: 20px;  
        }  
  
        .rotate-icon {  
            font-size: 5em;  
            animation: rotate 2s ease-in-out infinite;  
            margin-bottom: 20px;  
        }  
  
        @keyframes rotate {  
            0%, 100% { transform: rotate(0deg); }  
            50% { transform: rotate(90deg); }  
        }  
  
        .rotate-message h2 {  
            font-size: 2em;  
            margin-bottom: 10px;  
        }  
  
        .rotate-message p {  
            font-size: 1.2em;  
            opacity: 0.9;  
        }  
  
        @media (orientation: portrait) {  
            .rotate-message {  
                display: flex !important;  
            }  
            .container {  
                display: none !important;  
            }  
        }  
  
        .container {  
            width: 100%;  
            max-width: 900px;  
            padding: 20px;  
        }  
  
        .screen {  
            display: none;  
            animation: fadeIn 0.3s ease-in;  
        }  
  
        .screen.active {  
            display: block;  
        }  
  
        @keyframes fadeIn {  
            from { opacity: 0; transform: scale(0.95); }  
            to { opacity: 1; transform: scale(1); }  
        }  
  
        .menu-screen, .level-select, .results-screen, .settings-screen, .mode-select {  
            background: rgba(255, 255, 255, 0.95);  
            border-radius: 30px;  
            padding: 30px;  
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);  
            max-width: 600px;  
            margin: 0 auto;  
        }  
  
        .game-screen {  
            background: transparent;  
        }  
  
        .game-device {  
            background: linear-gradient(145deg, #2a2a2a, #1a1a1a);  
            border-radius: 40px;  
            padding: 30px 40px;  
            box-shadow:   
                0 30px 60px rgba(0, 0, 0, 0.5),  
                inset 0 2px 10px rgba(255, 255, 255, 0.1);  
            border: 3px solid #333;  
            position: relative;  
            max-width: 800px;  
            margin: 0 auto;  
        }  
  
        .device-header {  
            display: flex;  
            justify-content: space-between;  
            align-items: center;  
            margin-bottom: 20px;  
            padding: 10px 20px;  
            background: rgba(0, 0, 0, 0.3);  
            border-radius: 20px;  
        }  
  
        .led-display {  
            background: #000;  
            padding: 10px 20px;  
            border-radius: 10px;  
            border: 2px solid #444;  
            box-shadow: inset 0 2px 10px rgba(0, 0, 0, 0.5);  
        }  
  
        .led-digit {  
            display: inline-block;  
            font-family: 'Courier New', monospace;  
            font-size: 1.8em;  
            font-weight: bold;  
            color: #00ff00;  
            text-shadow: 0 0 10px #00ff00;  
            min-width: 30px;  
            text-align: center;  
        }  
  
        .led-label {  
            font-size: 0.7em;  
            color: #888;  
            text-transform: uppercase;  
            margin-top: 2px;  
        }  
  
        h1 {  
            text-align: center;  
            color: #667eea;  
            font-size: 2.5em;  
            margin-bottom: 10px;  
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.1);  
        }  
  
        .subtitle {  
            text-align: center;  
            color: #888;  
            margin-bottom: 30px;  
            font-size: 0.9em;  
        }  
  
        .btn {  
            width: 100%;  
            padding: 18px;  
            margin: 10px 0;  
            border: none;  
            border-radius: 15px;  
            font-size: 1.2em;  
            font-weight: bold;  
            cursor: pointer;  
            transition: all 0.3s ease;  
            text-transform: uppercase;  
            letter-spacing: 1px;  
        }  
  
        .btn-primary {  
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);  
            color: white;  
            box-shadow: 0 8px 20px rgba(102, 126, 234, 0.4);  
        }  
  
        .btn-primary:active {  
            transform: scale(0.95);  
            box-shadow: 0 4px 10px rgba(102, 126, 234, 0.4);  
        }  
  
        .btn-secondary {  
            background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);  
            color: white;  
            box-shadow: 0 8px 20px rgba(245, 87, 108, 0.4);  
        }  
  
        .btn-secondary:active {  
            transform: scale(0.95);  
        }  
  
        .btn-success {  
            background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);  
            color: white;  
        }  
  
        .game-grid {  
            display: grid;  
            grid-template-columns: repeat(8, 1fr);  
            gap: 12px;  
            margin: 20px 0;  
            padding: 25px;  
            background: linear-gradient(145deg, #3a3a3a, #2a2a2a);  
            border-radius: 30px;  
            box-shadow:   
                inset 0 5px 20px rgba(0, 0, 0, 0.5),  
                0 5px 15px rgba(0, 0, 0, 0.3);  
        }  
  
        .pop-button {  
            aspect-ratio: 1;  
            border: none;  
            border-radius: 50%;  
            background: linear-gradient(145deg, #4a4a4a, #2a2a2a);  
            box-shadow:   
                5px 5px 10px rgba(0, 0, 0, 0.5),  
                -2px -2px 8px rgba(255, 255, 255, 0.05);  
            cursor: pointer;  
            transition: all 0.15s ease;  
            position: relative;  
            overflow: hidden;  
        }  
  
        .pop-button::before {  
            content: '';  
            position: absolute;  
            top: 50%;  
            left: 50%;  
            width: 75%;  
            height: 75%;  
            background: #1a1a1a;  
            border-radius: 50%;  
            transform: translate(-50%, -50%);  
            transition: all 0.15s ease;  
            box-shadow: inset 2px 2px 5px rgba(0, 0, 0, 0.8);  
        }  
  
        .pop-button.lit::before {  
            background: radial-gradient(circle, #00ff88, #00cc66);  
            box-shadow:   
                0 0 20px #00ff88,  
                inset 0 0 10px rgba(255, 255, 255, 0.5);  
            animation: pulse 0.5s ease;  
        }  
  
        .pop-button.target::before {  
            background: radial-gradient(circle, #ff4444, #cc0000);  
            box-shadow:   
                0 0 25px #ff4444,  
                inset 0 0 10px rgba(255, 255, 255, 0.5);  
            animation: pulse 0.5s ease infinite;  
        }  
  
        .pop-button:active {  
            transform: scale(0.9);  
            box-shadow: inset 5px 5px 10px rgba(0, 0, 0, 0.7);  
        }  
  
        @keyframes pulse {  
            0%, 100% { transform: translate(-50%, -50%) scale(1); }  
            50% { transform: translate(-50%, -50%) scale(1.15); }  
        }  
  
        .stats {  
            display: flex;  
            justify-content: space-around;  
            margin: 20px 0;  
            padding: 15px;  
            background: rgba(102, 126, 234, 0.1);  
            border-radius: 15px;  
        }  
  
        .stat {  
            text-align: center;  
        }  
  
        .stat-value {  
            font-size: 2em;  
            font-weight: bold;  
            color: #667eea;  
        }  
  
        .stat-label {  
            font-size: 0.8em;  
            color: #666;  
            text-transform: uppercase;  
        }  
  
        .level-grid {  
            display: grid;  
            grid-template-columns: repeat(4, 1fr);  
            gap: 15px;  
            margin: 20px 0;  
        }  
  
        .level-btn {  
            aspect-ratio: 1;  
            border: none;  
            border-radius: 15px;  
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);  
            color: white;  
            font-size: 1.5em;  
            font-weight: bold;  
            cursor: pointer;  
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);  
            transition: all 0.3s ease;  
        }  
  
        .level-btn:active {  
            transform: scale(0.95);  
        }  
  
        .level-btn.locked {  
            background: #ccc;  
            cursor: not-allowed;  
            opacity: 0.5;  
        }  
  
        .stars {  
            text-align: center;  
            font-size: 3em;  
            margin: 20px 0;  
            color: #ffd700;  
            text-shadow: 0 0 10px rgba(255, 215, 0, 0.5);  
        }  
  
        .results-title {  
            text-align: center;  
            font-size: 2em;  
            color: #667eea;  
            margin-bottom: 20px;  
        }  
  
        .mode-description {  
            background: rgba(102, 126, 234, 0.1);  
            padding: 15px;  
            border-radius: 10px;  
            margin: 10px 0;  
            font-size: 0.9em;  
            color: #666;  
        }  
  
        .setting-item {  
            display: flex;  
            justify-content: space-between;  
            align-items: center;  
            padding: 15px;  
            margin: 10px 0;  
            background: rgba(102, 126, 234, 0.1);  
            border-radius: 10px;  
        }  
  
        .toggle {  
            position: relative;  
            width: 60px;  
            height: 30px;  
            background: #ccc;  
            border-radius: 15px;  
            cursor: pointer;  
            transition: background 0.3s ease;  
        }  
  
        .toggle.active {  
            background: #667eea;  
        }  
  
        .toggle::after {  
            content: '';  
            position: absolute;  
            width: 26px;  
            height: 26px;  
            border-radius: 50%;  
            background: white;  
            top: 2px;  
            left: 2px;  
            transition: left 0.3s ease;  
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.2);  
        }  
  
        .toggle.active::after {  
            left: 32px;  
        }  
  
        .back-btn {  
            width: auto;  
            padding: 10px 20px;  
            font-size: 1em;  
            margin-bottom: 20px;  
            background: #888;  
            color: white;  
        }  
  
        .countdown {  
            position: fixed;  
            top: 50%;  
            left: 50%;  
            transform: translate(-50%, -50%);  
            font-size: 6em;  
            font-weight: bold;  
            color: #fff;  
            text-shadow: 0 0 30px rgba(255, 255, 255, 0.8);  
            z-index: 1000;  
            animation: countdownPulse 1s ease;  
        }  
  
        @keyframes countdownPulse {  
            0% { transform: translate(-50%, -50%) scale(0); opacity: 0; }  
            50% { transform: translate(-50%, -50%) scale(1.2); }  
            100% { transform: translate(-50%, -50%) scale(1); opacity: 1; }  
        }  
  
        .progress-bar {  
            width: 100%;  
            height: 8px;  
            background: rgba(0, 0, 0, 0.3);  
            border-radius: 5px;  
            overflow: hidden;  
            margin: 15px 0;  
        }  
  
        .progress-fill {  
            height: 100%;  
            background: linear-gradient(90deg, #00ff88, #00cc66);  
            transition: width 0.3s ease;  
            border-radius: 5px;  
            box-shadow: 0 0 10px rgba(0, 255, 136, 0.5);  
        }  
  
        .device-controls {  
            display: flex;  
            justify-content: center;  
            gap: 15px;  
            margin-top: 20px;  
        }  
  
        .control-btn {  
            padding: 12px 24px;  
            border: none;  
            border-radius: 12px;  
            font-size: 1em;  
            font-weight: bold;  
            cursor: pointer;  
            background: linear-gradient(145deg, #555, #333);  
            color: #fff;  
            box-shadow:   
                3px 3px 8px rgba(0, 0, 0, 0.5),  
                -2px -2px 8px rgba(255, 255, 255, 0.05);  
            transition: all 0.2s ease;  
        }  
  
        .control-btn:active {  
            transform: scale(0.95);  
            box-shadow: inset 3px 3px 8px rgba(0, 0, 0, 0.5);  
        }  
    </style>  
</head>  
<body>  
    <div class="rotate-message">  
        <div class="rotate-icon">📱</div>  
        <h2>Please Rotate Your Device</h2>  
        <p>This game is best played in landscape mode</p>  
    </div>  
  
    <div class="container">  
        <div class="screen active menu-screen" id="menuScreen">  
            <h1>🎯 Pop It LED</h1>  
            <p class="subtitle">Test your speed and memory!</p>  
            <button class="btn btn-primary" onclick="game.showModeSelect()">Play</button>  
            <button class="btn btn-secondary" onclick="game.showSettings()">Settings</button>  
            <button class="btn btn-success" onclick="game.showStats()">High Scores</button>  
        </div>  
  
        <div class="screen mode-select" id="modeScreen">  
            <button class="btn back-btn" onclick="game.showMenu()">← Back</button>  
            <h1>Game Mode</h1>  
            <button class="btn btn-primary" onclick="game.selectMode('speed')">⚡ Speed Mode</button>  
            <div class="mode-description">Pop as many buttons as you can before time runs out!</div>  
            <button class="btn btn-secondary" onclick="game.selectMode('memory')">🧠 Memory Mode</button>  
            <div class="mode-description">Remember and repeat the pattern shown!</div>  
            <button class="btn btn-success" onclick="game.selectMode('sequence')">🎯 Sequence Mode</button>  
            <div class="mode-description">Pop the buttons in the correct order as they light up!</div>  
        </div>  
  
        <div class="screen level-select" id="levelScreen">  
            <button class="btn back-btn" onclick="game.showModeSelect()">← Back</button>  
            <h1>Select Level</h1>  
            <div class="level-grid" id="levelGrid"></div>  
        </div>  
  
        <div class="screen game-screen" id="gameScreen">  
            <div class="game-device">  
                <div class="device-header">  
                    <div class="led-display">  
                        <div class="led-digit" id="timeDisplay">30</div>  
                        <div class="led-label">Time</div>  
                    </div>  
                    <div class="led-display">  
                        <div class="led-digit" id="scoreDisplay">0</div>  
                        <div class="led-label">Score</div>  
                    </div>  
                    <div class="led-display">  
                        <div class="led-digit" id="levelDisplay">1</div>  
                        <div class="led-label">Level</div>  
                    </div>  
                </div>  
                <div class="progress-bar">  
                    <div class="progress-fill" id="progressFill" style="width: 0%"></div>  
                </div>  
                <div class="game-grid" id="gameGrid"></div>  
                <div class="device-controls">  
                    <button class="control-btn" onclick="game.endGame()">End Game</button>  
                </div>  
            </div>  
        </div>  
  
        <div class="screen results-screen" id="resultsScreen">  
            <h1 class="results-title">Level Complete!</h1>  
            <div class="stars" id="starsDisplay">⭐⭐⭐</div>  
            <div class="stats">  
                <div class="stat">  
                    <div class="stat-value" id="finalScore">0</div>  
                    <div class="stat-label">Pops</div>  
                </div>  
                <div class="stat">  
                    <div class="stat-value" id="finalTime">0</div>  
                    <div class="stat-label">Time</div>  
                </div>  
                <div class="stat">  
                    <div class="stat-value" id="accuracy">100%</div>  
                    <div class="stat-label">Accuracy</div>  
                </div>  
            </div>  
            <button class="btn btn-primary" onclick="game.nextLevel()">Next Level</button>  
            <button class="btn btn-secondary" onclick="game.retryLevel()">Retry</button>  
            <button class="btn btn-success" onclick="game.showMenu()">Menu</button>  
        </div>  
  
        <div class="screen settings-screen" id="settingsScreen">  
            <button class="btn back-btn" onclick="game.showMenu()">← Back</button>  
            <h1>⚙️ Settings</h1>  
            <div class="setting-item">  
                <span>Vibration</span>  
                <div class="toggle active" id="vibrationToggle" onclick="game.toggleVibration()"></div>  
            </div>  
            <div class="setting-item">  
                <span>Sound Effects</span>  
                <div class="toggle active" id="soundToggle" onclick="game.toggleSound()"></div>  
            </div>  
            <div class="setting-item">  
                <span>Difficulty</span>  
                <select id="difficultySelect" onchange="game.changeDifficulty()" style="padding: 10px; border-radius: 5px; border: 2px solid #667eea; font-size: 1em;">  
                    <option value="easy">Easy</option>  
                    <option value="medium" selected>Medium</option>  
                    <option value="hard">Hard</option>  
                </select>  
            </div>  
            <button class="btn btn-secondary" onclick="game.resetProgress()">Reset All Progress</button>  
        </div>  
    </div>  
  
    <script>  
        const game = {  
            settings: {  
                vibration: true,  
                sound: true,  
                difficulty: 'medium'  
            },  
            state: {  
                currentScreen: 'menuScreen',  
                mode: null,  
                level: 1,  
                score: 0,  
                time: 30,  
                timer: null,  
                sequence: [],  
                playerSequence: [],  
                target: null,  
                hits: 0,  
                misses: 0,  
                buttonsLit: new Set()  
            },  
            progress: {  
                speed: { unlockedLevel: 1, highScores: {} },  
                memory: { unlockedLevel: 1, highScores: {} },  
                sequence: { unlockedLevel: 1, highScores: {} }  
            },  
  
            init() {  
                this.loadProgress();  
                this.createGrid(32); 
                this.loadSettings();  
            },  
  
            loadSettings() {  
                const saved = localStorage.getItem('popitSettings');  
                if (saved) {  
                    this.settings = JSON.parse(saved);  
                    document.getElementById('vibrationToggle').classList.toggle('active', this.settings.vibration);  
                    document.getElementById('soundToggle').classList.toggle('active', this.settings.sound);  
                    document.getElementById('difficultySelect').value = this.settings.difficulty;  
                }  
            },  
  
            saveSettings() {  
                localStorage.setItem('popitSettings', JSON.stringify(this.settings));  
            },  
  
            loadProgress() {  
                const saved = localStorage.getItem('popitProgress');  
                if (saved) {  
                    this.progress = JSON.parse(saved);  
                }  
            },  
  
            saveProgress() {  
                localStorage.setItem('popitProgress', JSON.stringify(this.progress));  
            },  
  
            showScreen(screenId) {  
                document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));  
                document.getElementById(screenId).classList.add('active');  
                this.state.currentScreen = screenId;  
            },  
  
            showMenu() {  
                this.showScreen('menuScreen');  
            },  
  
            showModeSelect() {  
                this.showScreen('modeScreen');  
            },  
  
            showSettings() {  
                this.showScreen('settingsScreen');  
            },  
  
            showStats() {  
                alert('High scores feature coming soon!');  
            },  
  
            selectMode(mode) {  
                this.state.mode = mode;  
                this.showLevelSelect();  
            },  
  
            showLevelSelect() {  
                const grid = document.getElementById('levelGrid');  
                grid.innerHTML = '';  
                const maxLevel = this.progress[this.state.mode].unlockedLevel;  
                  
                for (let i = 1; i <= Math.max(12, maxLevel); i++) {  
                    const btn = document.createElement('button');  
                    btn.className = 'level-btn';  
                    btn.textContent = i;  
                    if (i <= maxLevel) {  
                        btn.onclick = () => this.startLevel(i);  
                    } else {  
                        btn.classList.add('locked');  
                        btn.innerHTML = '🔒';  
                    }  
                    grid.appendChild(btn);  
                }  
                  
                this.showScreen('levelScreen');  
            },  
  
            createGrid(size = 32) {  
                const grid = document.getElementById('gameGrid');  
                grid.innerHTML = '';  
                for (let i = 0; i < size; i++) {  
                    const btn = document.createElement('button');  
                    btn.className = 'pop-button';  
                    btn.dataset.index = i;  
                    btn.onclick = () => this.handlePop(i);  
                    grid.appendChild(btn);  
                }  
            },  
  
            async startLevel(level) {  
                this.state.level = level;  
                this.state.score = 0;  
                this.state.hits = 0;  
                this.state.misses = 0;  
                this.state.sequence = [];  
                this.state.playerSequence = [];  
                this.state.buttonsLit = new Set();  
                  
                document.getElementById('levelDisplay').textContent = level;  
                document.getElementById('scoreDisplay').textContent = 0;  
                document.getElementById('progressFill').style.width = '0%';
                
                document.querySelectorAll('.pop-button').forEach(b => {
                    b.classList.remove('lit');
                    b.classList.remove('target');
                });
                  
                this.showScreen('gameScreen');  
                  
                await this.showCountdown();  
                  
                if (this.state.mode === 'speed') {  
                    this.startSpeedMode();  
                } else if (this.state.mode === 'memory') {  
                    this.startMemoryMode();  
                } else if (this.state.mode === 'sequence') {  
                    this.startSequenceMode();  
                }  
            },  
  
            async showCountdown() {  
                for (let i = 3; i > 0; i--) {  
                    const countdown = document.createElement('div');  
                    countdown.className = 'countdown';  
                    countdown.textContent = i;  
                    document.body.appendChild(countdown);  
                    this.vibrate(100);  
                    await new Promise(resolve => setTimeout(resolve, 1000));  
                    countdown.remove();  
                }  
                const go = document.createElement('div');  
                go.className = 'countdown';  
                go.textContent = 'GO!';  
                document.body.appendChild(go);  
                this.vibrate(200);  
                await new Promise(resolve => setTimeout(resolve, 500));  
                go.remove();  
            },  
  
            startSpeedMode() {  
                const difficulty = { easy: 45, medium: 30, hard: 20 };  
                this.state.time = difficulty[this.settings.difficulty];  
                this.startTimer();  
                this.nextTarget();  
            },  
  
            startMemoryMode() {  
                this.state.time = 60;  
                const patternLength = Math.min(5 + this.state.level * 2, 20);  
                this.state.sequence = [];  
                for (let i = 0; i < patternLength; i++) {  
                    this.state.sequence.push(Math.floor(Math.random() * 32));  
                }  
                this.showPattern();  
            },  
  
            async showPattern() {  
                document.getElementById('timeDisplay').textContent = '--';  
                const buttons = document.querySelectorAll('.pop-button');  
                  
                for (let idx of this.state.sequence) {  
                    await new Promise(resolve => setTimeout(resolve, 500));  
                    buttons[idx].classList.add('target');  
                    this.vibrate(50);  
                    await new Promise(resolve => setTimeout(resolve, 500));  
                    buttons[idx].classList.remove('target');  
                }  
                  
                await new Promise(resolve => setTimeout(resolve, 1000));  
                document.getElementById('timeDisplay').textContent = 'GO';
                this.startTimer();  
            },  
  
            startSequenceMode() {  
                const difficulty = { easy: 40, medium: 30, hard: 20 };  
                this.state.time = difficulty[this.settings.difficulty];  
                this.startTimer();  
                this.startSequence();  
            },  
  
            async startSequence() {  
                const sequenceLength = Math.min(5 + this.state.level * 2, 20);  
                this.state.sequence = [];  
                for (let i = 0; i < sequenceLength; i++) {  
                    this.state.sequence.push(Math.floor(Math.random() * 32));  
                }  
                this.state.playerSequence = [];  
                this.showSequenceProgress();  
                this.highlightNextInSequence();  
            },  
  
            highlightNextInSequence() {  
                const buttons = document.querySelectorAll('.pop-button');  
                buttons.forEach(b => b.classList.remove('target'));  
                  
                if (this.state.playerSequence.length < this.state.sequence.length) {  
                    const nextIdx = this.state.sequence[this.state.playerSequence.length];  
                    buttons[nextIdx].classList.add('target');  
                }  
            },  
  
            showSequenceProgress() {  
                const progress = (this.state.playerSequence.length / this.state.sequence.length) * 100;  
                document.getElementById('progressFill').style.width = progress + '%';  
            },  
  
            handlePop(index) {  
                // Ensure index is an integer
                const popIndex = parseInt(index);

                if (this.state.mode === 'speed') {  
                    if (popIndex === this.state.target) {  
                        this.state.score++;  
                        this.state.hits++;  
                        document.getElementById('scoreDisplay').textContent = this.state.score;  
                        this.lightUp(popIndex);  
                        this.vibrate(50);  
                        this.nextTarget();  
                    } else {  
                        this.state.misses++;  
                        this.vibrate([50, 50, 50]);  
                    }  
                } else if (this.state.mode === 'memory') {  
                    if (this.state.timer) { // Only record pops if the game is active
                        this.state.playerSequence.push(popIndex);  
                        this.lightUp(popIndex);  
                        this.vibrate(50);  
                          
                        if (this.state.playerSequence.length === this.state.sequence.length) {  
                            this.checkMemorySequence();  
                        }
                    }  
                } else if (this.state.mode === 'sequence') {  
                    const expectedIdx = this.state.sequence[this.state.playerSequence.length];  
                    if (popIndex === expectedIdx) {  
                        this.state.playerSequence.push(popIndex);  
                        this.state.score++;  
                        this.state.hits++;  
                        document.getElementById('scoreDisplay').textContent = this.state.score;  
                        this.lightUp(popIndex);  
                        this.vibrate(50);  
                        this.showSequenceProgress();  
                          
                        if (this.state.playerSequence.length === this.state.sequence.length) {  
                            this.completeLevel();  
                        } else {  
                            this.highlightNextInSequence();  
                        }  
                    } else {  
                        this.state.misses++;  
                        this.vibrate([50, 50, 50]);  
                    }  
                }  
            },  
  
            checkMemorySequence() {  
                const correct = this.state.sequence.every((val, idx) => val === this.state.playerSequence[idx]);  
                if (correct) {  
                    this.state.score = this.state.sequence.length;  
                    this.state.hits = this.state.score;  
                    this.completeLevel();  
                } else {  
                    this.state.misses = this.state.sequence.length;  
                    this.completeLevel();  
                }  
            },  
  
            nextTarget() {  
                const buttons = document.querySelectorAll('.pop-button');  
                buttons.forEach(b => b.classList.remove('target'));  
                this.state.target = Math.floor(Math.random() * 32); 
                buttons[this.state.target].classList.add('target');  
            },  
  
            lightUp(index) {  
                const buttons = document.querySelectorAll('.pop-button');  
                buttons[index].classList.add('lit');  
                this.state.buttonsLit.add(index);  
                setTimeout(() => {  
                    buttons[index].classList.remove('lit');  
                }, 300);  
            },  
  
            startTimer() {  
                document.getElementById('timeDisplay').textContent = this.state.time;  
                this.state.timer = setInterval(() => {  
                    this.state.time--;  
                    document.getElementById('timeDisplay').textContent = this.state.time;  
                    if (this.state.time <= 0) {  
                        this.completeLevel();  
                    }  
                }, 1000);  
            },  
  
            completeLevel() {  
                if (this.state.timer) {  
                    clearInterval(this.state.timer);  
                    this.state.timer = null; 
                }  
                  
                const buttons = document.querySelectorAll('.pop-button');  
                buttons.forEach(b => {  
                    b.classList.remove('target');  
                    b.classList.remove('lit');  
                });  
                  
                this.showResults();  
            },  
  
            showResults() {  
                const totalAttempts = this.state.hits + this.state.misses;  
                const accuracy = totalAttempts > 0 ? Math.round((this.state.hits / totalAttempts) * 100) : 0;  
                  
                let stars = 1;  
                if (this.state.mode === 'speed') {  
                    const scoreGoal = { easy: 20, medium: 30, hard: 40 };
                    if (this.state.score >= scoreGoal[this.settings.difficulty] + this.state.level * 5) stars = 3;  
                    else if (this.state.score >= scoreGoal[this.settings.difficulty] / 2 + this.state.level * 3) stars = 2;  
                    else stars = 1;
                } else if (this.state.mode === 'memory' || this.state.mode === 'sequence') {  
                    if (accuracy === 100 && this.state.hits > 0) stars = 3;  
                    else if (accuracy >= 80 && this.state.hits > 0) stars = 2;
                    else if (this.state.hits > 0) stars = 1;
                    else stars = 0;
                }  

                const resultsTitle = document.querySelector('#resultsScreen .results-title');
                if (stars === 3) {
                    resultsTitle.textContent = 'Perfect!';
                } else if (stars === 2) {
                    resultsTitle.textContent = 'Level Complete!';
                } else {
                    resultsTitle.textContent = 'Try Again!';
                }
                  
                document.getElementById('starsDisplay').textContent = '⭐'.repeat(stars) + '☆'.repeat(3 - stars);  
                document.getElementById('finalScore').textContent = this.state.score;  
                
                // Calculate time taken for display
                let startingTime = 30;
                if (this.state.mode === 'memory') startingTime = 60;
                if (this.state.mode === 'sequence') startingTime = { easy: 40, medium: 30, hard: 20 }[this.settings.difficulty];

                const timeTaken = Math.max(0, startingTime - this.state.time); 
                document.getElementById('finalTime').textContent = timeTaken + 's';
                document.getElementById('accuracy').textContent = accuracy + '%';  
                  
                if (stars >= 2) {  
                    const nextLevel = this.state.level + 1;  
                    if (nextLevel > this.progress[this.state.mode].unlockedLevel) {  
                        this.progress[this.state.mode].unlockedLevel = nextLevel;  
                        this.saveProgress();  
                    }  
                }  
                  
                this.showScreen('resultsScreen');  
                this.vibrate([100, 50, 100, 50, 200]);  
            },  
  
            nextLevel() {  
                if (this.state.level + 1 <= this.progress[this.state.mode].unlockedLevel) {  
                    this.startLevel(this.state.level + 1);  
                } else {  
                    this.showLevelSelect();  
                }  
            },  
  
            retryLevel() {  
                this.startLevel(this.state.level);  
            },  
  
            endGame() {  
                if (this.state.timer) {  
                    clearInterval(this.state.timer);  
                }  
                this.showMenu();  
            },  
  
            vibrate(pattern) {  
                if (this.settings.vibration && navigator.vibrate) {  
                    navigator.vibrate(pattern);  
                }  
            },  
  
            toggleVibration() {  
                this.settings.vibration = !this.settings.vibration;  
                document.getElementById('vibrationToggle').classList.toggle('active', this.settings.vibration);  
                this.saveSettings();  
                this.vibrate(50);  
            },  
  
            toggleSound() {  
                this.settings.sound = !this.settings.sound;  
                document.getElementById('soundToggle').classList.toggle('active', this.settings.sound);  
                this.saveSettings();  
            },  
  
            changeDifficulty() {  
                this.settings.difficulty = document.getElementById('difficultySelect').value;  
                this.saveSettings();  
            },  
  
            resetProgress() {  
                if (confirm('Are you sure you want to reset all progress? This cannot be undone!')) {  
                    this.progress = {  
                        speed: { unlockedLevel: 1, highScores: {} },  
                        memory: { unlockedLevel: 1, highScores: {} },  
                        sequence: { unlockedLevel: 1, highScores: {} }  
                    };  
                    this.saveProgress();  
                    alert('Progress reset successfully!');  
                    this.showMenu();  
                }  
            }  
        };  
  
        game.init();  
    </script>  
</body>  
</html>
